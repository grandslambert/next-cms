# Version 3.0.3 - 2025-01-21

## Fixed

### **Database Architecture Fixes**
- Fixed critical issues with multi-database architecture where Site ID references were inconsistent
- Changed Site references from `Site._id` (ObjectId) to `Site.id` (Number) throughout the codebase
- Fixed `SiteUser.site_id` and `UserMeta.site_id` to use Number instead of ObjectId
- Removed `site_id` filters from all site-specific models (they're in separate databases)

### **SuperAdmin Functionality**
- **User Management**
  - Fixed user creation with proper role validation using `GlobalModels.Role()`
  - Fixed site_id conversion from ObjectId to Number in site assignments
  - Fixed user list queries to use numeric site IDs
- **Site Management**
  - Fixed all site routes (GET, POST, PUT, DELETE) to use `Site.findOne({ id: siteId })`
  - Fixed site creation to use numeric IDs for database initialization
  - Fixed site user assignment routes to use numeric site_id
  - Fixed site switching to use numeric site ID validation
- **Activity Logging**
  - Fixed activity log to correctly log to global database for SuperAdmin actions
  - Fixed activity log viewer to query global database by default for SuperAdmin
  - Removed site_id from global action logging (user creation, site creation, etc.)
  - Fixed site lookup in activity logs to use numeric site.id

### **API Routes**
- **Post Types**: Completely rewritten to use `SiteModels.PostType(siteId)` and removed site_id filters
- **Settings**: Removed site_id filters from site-specific settings queries
- **User Metadata**: Fixed to use numeric site_id in global UserMeta model
- **Site Users**: Fixed all routes to use numeric site_id for SiteUser queries
- **Authentication**: Fixed switch-site route to use numeric site ID

### **Developer Experience**
- Added `dev:clean` script to kill node processes and clear build caches
- Separated dev startup from cache cleaning for better control
- Created comprehensive database structure documentation (`DATABASE_STRUCTURE_FINAL.md`)
- Created fix tracking documents (`FIXES_APPLIED.md`, `FIXES_NEEDED.md`)

## Technical Details

### Database Structure
- **Global Database** (`nextcms_global`): Users, Roles, Sites, SiteUser, UserMeta, Global Settings, Global Activity Logs
- **Site Databases** (`nextcms_site{id}`): All content and site-specific data (15 collections per site)
- **Key Rule**: `Site.id` (Number) is used for all site references and database naming
- **Site-specific models**: No `site_id` field - database isolation provides separation

### Files Updated
- Core SuperAdmin routes: 13 files
- Model factory and activity logger
- Settings and authentication routes
- Database documentation and tracking files
- Version files: package.json, VERSION, README.md, VERSIONING.md, Sidebar.tsx

## Known Issues
- Content management routes (Posts, Media, Menus, Taxonomies) still need migration to new model system (~40 files)
- Legacy v1 API routes not updated (36 files)
- These will be addressed in future updates as needed

## Notes
This is a critical patch that fixes the core SuperAdmin functionality after the v3.0.0 migration to multi-database architecture. All SuperAdmin operations (user management, site management, activity logging) now work correctly with the new database structure.

