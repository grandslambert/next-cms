# Version 1.8.0 - 2025-09-16

## Added
- **Pending Review Status and Publishing Workflow**
  - New `pending` status for posts awaiting review
  - `can_publish` permission controls who can publish posts directly
  - Users without `can_publish` see "Submit for Review" button instead of "Publish"
  - Submitted posts appear with blue "Pending Review" badge in lists
  - Admins and Editors can publish by default; can be customized per role
  - Authors can submit for review, requiring approval from publisher
- **Granular Delete Permissions**
  - `can_delete` permission controls deletion of own posts
  - `can_delete_others` permission controls deletion of others' posts
  - Delete button visibility based on ownership and permissions
  - API enforces permission checks for all delete operations
  - Default permissions:
    - Admin: Can delete own and others' posts
    - Editor: Can delete own and others' posts
    - Author: Can delete own posts only
- **Granular Post Visibility Control**
  - New `view_others_posts` permission controls visibility of others' posts in lists
  - Independent from `manage_others_posts` (edit/delete) permission
  - Allows fine-grained access control: users can edit without viewing full lists
  - Default permissions by role:
    - Admin: Can view and manage all posts
    - Editor: Can manage others' posts but only sees own posts in lists (customizable)
    - Author: Can only view and manage their own posts
  - Editors with `manage_others_posts` can edit via direct URL but won't see others' posts in sidebar
  - API enforces permission at query level for optimal performance
- "Content Types" submenu in admin sidebar
  - Hover to reveal Post Types and Taxonomies options
  - Auto-expands when on any Content Types page
  - Clean, organized navigation structure
  - New "Content Types" menu item (position 27)
- "Taxonomies" submenu in admin sidebar (position 22)
  - Dynamically populated with all taxonomies where `show_in_menu` is true
  - Categories and Tags appear here by default
  - Hover to reveal submenu with all active taxonomies
  - Auto-expands when viewing any taxonomy term management page
  - Positioned just below Media for easy access to content organization
- **Taxonomy dashboard cards**
  - New `show_in_dashboard` option for taxonomies
  - Taxonomies can now appear in the Dashboard Content Summary
  - Shows term count for each taxonomy
  - Filtered by user's `manage_taxonomies` permission
  - Uses appropriate icons (üè∑Ô∏è for hierarchical, üîñ for flat)
  - Clickable cards link to taxonomy term management page
- "Users" submenu in admin sidebar
  - "All Users" for user management
  - "Roles" for roles and permissions management
  - Auto-expands when on any Users page
- **Custom Roles & Permissions System**
  - Create custom user roles with granular permission sets
  - Dedicated "Roles" management page under Users
  - **Per-post-type permissions**: Each post type has its own access permission (e.g., `manage_posts_post`, `manage_posts_page`)
  - Core permissions organized by category (General, Administration)
  - Post type permissions dynamically generated based on registered post types
  - Users can be granted access to specific post types only
  - `manage_others_posts` applies across all post types the user has access to
  - Eight core permissions: view_dashboard, manage_others_posts, manage_media, manage_taxonomies, manage_users, manage_roles, manage_post_types, manage_settings
  - System roles (Admin, Editor, Author) are pre-configured and protected from deletion
  - Custom roles can be created, edited, and deleted
  - **Clone role feature**: Quickly create new roles based on existing ones
  - Cloned roles are independent and don't sync with the original
  - Clone button available for all roles (system and custom)
  - Auto-generates name with "_copy" suffix and "(Copy)" in display name
  - Roles with assigned users cannot be deleted until users are reassigned
  - Permission checkboxes organized by category with clear descriptions
  - Side-by-side layout: roles list on left, edit form on right
  - Permission badges color-coded: green for core permissions, blue for post types
- **Database Schema**
  - New `roles` table with permissions stored as JSON
  - Users table now references `role_id` instead of ENUM
  - Default roles automatically created with appropriate permissions
  - Foreign key relationship between users and roles
- **Permission-based sidebar filtering**
  - Menu items filtered based on user's role permissions
  - Post types only appear if user has the specific post type permission
  - Example: User with only `manage_posts_page` will only see Pages in sidebar
  - Seamless UX - unauthorized items simply don't appear
  - Subitems also respect permissions for granular access control
  - Works with custom roles and system roles alike
- **Page-level permission protection**
  - Created `usePermission` hook for consistent permission checking across pages
  - All admin pages now validate user permissions before rendering
  - Automatic redirect to dashboard if user lacks required permission
  - Prevents URL-based permission bypass attempts
  - Protected pages:
    - Users management (requires `manage_users`)
    - Roles management (requires `manage_roles`)
    - Media library (requires `manage_media`)
    - Settings pages (requires `manage_settings`)
    - Content Types management (requires `manage_post_types`)
    - Taxonomy term management (requires `manage_taxonomies`)
    - Post type lists and editors (requires `manage_posts_[posttype]` for specific type)
  - Shows loading spinner during permission check
  - Seamless redirect without error messages for better UX
- **API-level permission enforcement**
  - `manage_others_posts` permission now properly enforced in API routes
  - POST `/api/posts` - Users can create posts for post types they have access to
  - PUT `/api/posts/[id]` - Users can only edit their own posts unless they have `manage_others_posts`
    - Returns 403 if attempting to publish without `can_publish` permission
  - DELETE `/api/posts/[id]` - Checks `can_delete` for own posts, `can_delete_others` for others' posts
    - Returns 403 with specific error message for each permission failure
  - GET `/api/posts` - Users without `view_others_posts` only see their own posts in lists
  - Ownership checked by comparing post's `author_id` with session user ID
- **Editor-level permission enforcement**
  - Post editor checks ownership when loading posts for editing
  - Users without `manage_others_posts` cannot access edit pages for others' posts
  - Automatic redirect to post type list if unauthorized
  - Shows error toast explaining the restriction
- **UI-level permission enforcement**
  - Edit links disabled (grayed out) for posts user can't edit
  - Hover tooltip explains lack of permission
  - Title is non-clickable for posts user can't edit
  - Delete button hidden in post lists for posts user can't delete
  - Clean visual indication of permission restrictions

## Changed
- **Post editor button labels**
  - "Publish Post" button now displays "Update Post" when editing already-published posts
  - More intuitive action labels based on post state
  - Draft posts still show "Publish Post" to indicate status change
- Post Types and Taxonomies moved from Settings to Content Types
  - Now accessed via sidebar submenu
  - Settings simplified to General and Media only
  - Clearer separation between site settings and content structure
  - Each page (Post Types, Taxonomies) has its own header
  - No tabbed navigation - rely on sidebar for navigation
- Taxonomies settings page redesigned with side-by-side layout
  - Existing taxonomies list on left with "+ Add New" button
  - Create/Edit form on right (shows when creating or editing)
  - Matches Post Types editor layout for consistency
  - Compact card-based list with inline badges for type and built-in status
  - Improved form layout with better spacing and descriptions
- Settings navigation redesigned with sidebar submenu
  - Settings menu item now has General and Media subitems
  - Hover to reveal submenu options
  - Auto-expands when on any Settings page
  - Each settings page has its own dedicated header
  - Removed tabbed navigation from Settings layout
  - Consistent navigation pattern with Content Types
- Taxonomy menu items moved to dedicated submenu
  - Individual taxonomies (Categories, Tags, etc.) no longer appear as separate top-level menu items
  - Now grouped under "Taxonomies" submenu for better organization
  - Maintains same functionality with cleaner navigation
  - Respects `show_in_menu` setting for each taxonomy
- **User authentication system updated for custom roles**
  - Session now includes role permissions in addition to role name
  - Auth system fetches user's role and permissions from database on login
  - JWT token stores permissions for efficient authorization checks
  - All permission checks use the permissions object from session
- **Users API updated for role_id**
  - User queries now JOIN with roles table to include role information
  - API responses include both `role_id` and `role_display_name`
  - Users page updated to display and manage role assignments
  - Role dropdown now dynamically populated from roles table
- **API Routes for Roles Management**
  - `GET /api/roles` - List all roles with permissions
  - `POST /api/roles` - Create new custom role
  - `GET /api/roles/[id]` - Get specific role details
  - `PUT /api/roles/[id]` - Update role (permissions for system roles, all fields for custom)
  - `DELETE /api/roles/[id]` - Delete custom role (protected if users assigned)
  - All routes check `manage_roles` permission

## Fixed
- Removed all legacy category API routes and admin pages
  - Deleted `app/api/categories` (replaced by terms API)
  - Deleted `app/api/posts/[id]/categories` (replaced by terms relationship API)
  - Deleted `app/admin/categories` (replaced by taxonomy term management)
  - Deleted empty `app/api/pages` folder
- Updated media usage checks to use new taxonomy system
  - Now checks `terms` table instead of old `categories` table
  - Removed checks for old `pages` table (now part of posts)
  - Media deletion response now shows posts and terms usage
- Dashboard content summary now respects user permissions
  - Post types only appear if user has the specific `manage_posts_[posttype]` permission
  - Taxonomies only appear if user has `manage_taxonomies` permission AND taxonomy has `show_in_dashboard` enabled
  - Media card only shows if user has `manage_media` permission
  - Users card only shows if user has `manage_users` permission
  - Removed deprecated Categories card from dashboard
- Taxonomy settings page updated
  - Added "Show in Dashboard Content Summary" checkbox
  - Allows controlling which taxonomies appear on the dashboard
  - Works alongside existing "Show in admin menu" option

