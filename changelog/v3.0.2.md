# Version 3.0.2 - October 21, 2025

## Fixed

### User Switching
- **JWT Callback**:
  - Added `switchData` handling in JWT callback for proper user switching
  - Now correctly updates all user fields when switching users (id, email, name, role, permissions, isSuperAdmin, currentSiteId, originalUserId, isSwitched)
  - Fixed session persistence after user switch

- **Type Definitions**:
  - Added `username`, `first_name`, `last_name`, `email`, `name` to NextAuth JWT and Session interfaces
  - Changed all user/media ID types from `number` to `string` for MongoDB ObjectIds

### Media Library
- **Upload & Image Processing**:
  - Fixed field name mapping: `mimetype` → `mime_type`, `original_filename` → `original_name`, `filepath` → `url`
  - Implemented proper image size generation using media settings with crop styles
  - Image size filenames now use size names (e.g., `image-123-thumbnail.jpg`) instead of dimensions
  - Fixed console logging for size generation removed from production code

- **Folder Navigation**:
  - Fixed folder navigation showing correct subfolders instead of parent folders
  - Added folder counts (file_count, subfolder_count) to folder listings
  - Fixed `parent_id` filtering in folder queries

- **Trash Management**:
  - Added trash count badge on Trash button
  - Fixed trash count to update after all trash operations (delete, restore, empty)
  - Added `site_id` filtering to empty trash operation (was incorrectly deleting from all sites)

- **File Deletion**:
  - Fixed permanent deletion to remove ALL size variants, not just the original
  - Applies to single delete, bulk delete, and empty trash operations
  - Each size variant file is now properly deleted from the server

- **Bulk Actions**:
  - Fixed 405 Method Not Allowed error (changed endpoint from PUT to POST)
  - Fixed parameter mismatch (`ids` → `media_ids`)
  - Added support for both 'trash' and 'delete' action names
  - Added "Regenerate Sizes" bulk action for selected images
  - Fixed folder ID type mismatches (number → string)

- **Folder Selectors**:
  - Implemented hierarchical folder display in move modals
  - Shows proper indentation and tree structure (└─) for subfolders
  - Applies to both single and bulk move operations

### Image Regeneration
- **Regenerate API**:
  - Fully implemented image size regeneration using Sharp
  - Loads current image size settings from database (or defaults)
  - Supports single image or bulk regeneration
  - Deletes old size variant files before creating new ones
  - Generates new sizes with proper crop styles (cover, contain, fill, inside)
  - Updates database with new sizes JSON and dimensions
  - Returns success/failure counts

## Changed

### Media Library
- **ID Types**: All media and folder IDs now use string type for MongoDB ObjectIds throughout frontend and backend
- **Bulk Actions**: Enhanced with better user feedback messages
- **Trash Badge**: Only shows when count > 0 for cleaner UI

## Technical

### Database
- Added `sizes` field to Media model to store JSON data for generated image sizes
- Fixed site_id filtering in multiple media API endpoints

### API Endpoints
- Updated media routes to properly map database fields to frontend expectations
- Fixed bulk action endpoint method and parameter names
- Enhanced regenerate endpoint with full Sharp implementation

### Components
- Updated MediaGrid, TrashView, BulkMoveModal, MoveMediaModal with string ID types
- Added hierarchical folder rendering logic to move modals
- Improved trash count query and cache invalidation

