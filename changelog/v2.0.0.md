# Version 2.0.0 - 2025-10-17

## ðŸš¨ BREAKING CHANGES
- **Complete Database Restructure** - Fresh installations now multi-site by default
- **New Schema Required** - Existing installations need migration (see MULTI_SITE.md)
- **Site-Prefixed Tables** - All site-specific tables now use `site_{id}_` prefix
- **New Default Users** - Super admin and site admin accounts replace old admin

## Changed
- **Database Schema Multi-Site by Default** - Complete restructure of database schema
  - Schema now creates multi-site structure from the start (no migration needed)
  - Default Site 1 (`site_1_*` tables) created automatically
  - Super Administrator account created by default (username: `superadmin`, password: `SuperAdmin123!`)
  - Site Administrator account for Site 1 created by default (username: `siteadmin`, password: `SiteAdmin123!`)
  - Site admin automatically assigned to Site 1
  - Global tables: `users`, `roles`, `sites`, `site_users`, `user_meta`, `activity_log`
  - Site-specific tables: `site_1_posts`, `site_1_media`, `site_1_settings`, etc.
  - Removed all migration scripts (no longer needed)
  - Removed old seed.sql (data now in schema.sql)
  - Updated `database/schema.sql` to be the single source of truth
  - Fixed site_users assignment query for better MySQL compatibility
  - Updated login screen to show new default accounts (superadmin and siteadmin)
  - Login now accepts both username and email (e.g., "superadmin" or "superadmin@example.com")
  - Fixed site creation to read template directly instead of calling deleted script
  - Added enhanced error logging for site table creation debugging
- **Site Creation UX Improvements** - Streamlined add site form
  - Display Name field moved to top position
  - Name field auto-generated from Display Name
  - Name field disabled on edit (used for table prefix)
  - Smart slug generation: removes special characters, converts to lowercase
  - Helper text explains purpose and generation logic

## Added
- **User Switching Feature** - Super admins and admins can now switch to other users for testing
  - Switch to any user account directly from the user list
  - "ðŸ”„ Switch" action button added to each user row for quick switching
  - Original session is preserved - can always switch back
  - Visual indicators show when viewing as another user (yellow warning badge)
  - "ðŸ”™ Switch Back" button shown in sidebar when in testing mode
  - All actions are logged with the original user ID for accountability
  - Security: Regular admins cannot switch to super admin accounts
  - New API endpoints: `POST/DELETE /api/auth/switch-user`
  - Session data includes `originalUserId` and `isSwitched` flags
  - New component: `SwitchBackButton.tsx` for sidebar switch back action
  - Documented in `USER_SWITCHING.md`

## Changed
- **Super Admin Interface Simplified** - Super admins now have a focused, streamlined interface
  - Super admins only see "Sites" and "Users" in the sidebar menu
  - Dashboard automatically redirects super admins to Sites management
  - Site switcher hidden for super admins (they manage all sites, not assigned to specific sites)
  - Super admins focus on system administration (sites and users) rather than content
  - Regular admins continue to see full content management interface
- **User Management Site-Aware** - User list and creation now respects site context
  - Site admins only see users assigned to their current site
  - Creating a new user as site admin automatically assigns them to current site
  - Super admins continue to see all users globally with site assignment badges
  - Super admin user list shows which sites each user is assigned to
  - Site assignments displayed as colored badges with site names
  - "Not assigned" indicator for users without site assignments
  - User list filtered by `site_users` table for site admins

## Fixed
- **Dashboard Super Admin Permissions** - Fixed dashboard to properly recognize super admin permissions
  - Fixed: `app/admin/page.tsx` - Dashboard now explicitly checks `isSuperAdmin` flag and redirects to Sites
  - Fixed: `components/admin/Sidebar.tsx` - Super admins see simplified menu
  - Super admin now properly bypasses all permission checks
  - Content admins (non-super) continue to see full dashboard
- **Multi-Site Public Routes** - Updated all public-facing routes and helpers for multi-site support
  - Fixed: `app/(public)/[...slug]/page.tsx` - Dynamic routing now site-aware
  - Fixed: `app/(public)/page.tsx` - Home page now uses site-prefixed tables
  - Fixed: `app/(public)/blog/page.tsx` - Blog archive now site-aware
  - Fixed: `app/(public)/blog/[...slug]/page.tsx` - Blog posts now site-aware
  - Fixed: `lib/post-utils.ts` - All helper functions now accept `siteId` parameter
  - Fixed: `lib/post-url-builder.ts` - URL building now site-aware
  - Fixed: `lib/menu-helpers.ts` - Menu helpers now use site-prefixed tables
  - All public routes default to site 1 (ready for domain-based routing)
  - Resolves console errors on login screen and public pages
- **Multi-Site Menu Helper** - Fixed menu helper function to use site-prefixed tables (resolves "Table 'menus' doesn't exist" errors)
  - Fixed: `lib/menu-helpers.ts` - All table references now site-prefixed
  - Fixed: `buildHierarchicalSlugPath` helper function now site-aware
  - Updated: `components/public/Menu.tsx` - Now accepts optional `siteId` parameter
  - Menu queries now use site-specific `menus`, `menu_items`, `posts`, `taxonomies`, and `terms` tables
  - Public menus default to site 1, but can be customized per component instance
- **Multi-Site Post Routes** - Fixed remaining post routes that weren't using site-prefixed tables (resolves "Table 'posts' doesn't exist" errors)
  - Fixed: `app/api/posts/[id]/revisions/route.ts` - Now uses site-prefixed tables
  - Fixed: `app/api/posts/[id]/restore/route.ts` - Post restore now works per site
  - Fixed: `app/api/posts/[id]/permanent-delete/route.ts` - Permanent delete now site-aware with cascade
  - Fixed: `app/api/posts/trash/empty/route.ts` - Empty trash now site-aware with proper cascade delete
  - Fixed: `app/api/post-types/[id]/route.ts` - Post type deletion check now site-aware
  - Added super admin checks to all routes
  - Fixed parseInt comparisons for consistency
  - Added proper cascading deletes for post meta, revisions, and term relationships
  - All post operations now fully multi-site compatible
  - Documented in `MULTI_SITE_TABLE_FIX.md`
- **Multi-Site Support** - Complete framework for managing multiple sites from one CMS installation
  - New `sites` table to store site definitions
  - New `site_users` table to map users to sites with specific roles
  - Sites management UI at `/admin/sites` (Super Admin only)
  - API endpoints for CRUD operations on sites (`/api/sites`)
  - Each site gets its own database tables with prefix `site_{id}_`
  - Site-specific tables: posts, media, menus, taxonomies, settings, etc.
  - Global resources: users, roles shared across all sites
  - Automatic table creation when adding new sites
  - Migration script for existing installations (`scripts/migrate-to-multi-site.js`)
  - Site setup script (`scripts/create-site-tables.js`)
  - Database helper utilities for site-prefixed table names (`getSiteTable`, `getSitePrefix`, `getSiteTableSafe`)
  - Comprehensive documentation in `MULTI_SITE.md`
  - Site tables template (`database/site-tables-template.sql`)
  - Multi-site schema (`database/multi-site-schema.sql`)
  - Default site (ID: 1) created automatically
  - Sites menu item in admin sidebar (Super Admin only)
  - Protection: Default site cannot be deleted
  - Safety: Deleted sites' tables are preserved (must drop manually)
  - **Core API Routes Updated for Multi-Site**:
    - Posts API - All routes use site-prefixed tables (`/api/posts/*`)
    - Post Types API - All routes use site-prefixed tables (`/api/post-types/*`)
    - Media API - All routes use site-prefixed tables (`/api/media/*`)
    - Taxonomies API - All routes use site-prefixed tables (`/api/taxonomies/*`)
    - Terms API - All routes use site-prefixed tables (`/api/terms/*`)
    - Menus API - All routes use site-prefixed tables (`/api/menus/*`)
    - Settings API - All routes use site-prefixed tables (`/api/settings/*`)
    - Activity Log API - Uses site-prefixed tables (`/api/activity-log`)
  - User session now includes `currentSiteId` for context
  - Activity logger updated to log to site-specific tables
  - All database queries dynamically use site context from session
  - **Site Switcher UI** - Easy site switching for users with multi-site access
    - Dropdown selector in admin header bar
    - Shows all sites user has access to (Super Admin sees all active sites)
    - Displays current site and domain
    - Smooth switching with session update and page reload
    - Only shows when user has access to multiple sites
    - Shows user's role per site for non-super admins
    - API endpoint for switching sites (`/api/auth/switch-site`)
    - API endpoint for fetching available sites (`/api/sites/available`)
  - **Site User Management** - Assign users to sites with specific roles
    - "Users" button on each site in Sites management page
    - Modal interface for managing site users
    - Add users to sites with role selection
    - Change user roles for specific sites
    - Remove users from sites
    - Shows count of assigned users per site
    - View all users assigned to a site
    - Filter available users (excludes already assigned)
    - API endpoints for site user CRUD operations (`/api/sites/[id]/users/*`)
    - Activity logging for all site user changes
- **Super Admin Role** - Built-in super administrator role with unrestricted access
  - New `super_admin` role (ID: 0) that bypasses all permission checks
  - Super admins automatically have access to all features without explicit permissions
  - System role that cannot be deleted, edited, or cloned through the UI
  - Protected at API level - cannot be modified via backend endpoints
  - "Protected Role" indicator shown in roles list instead of Edit/Clone buttons
  - Migration script (`scripts/add-super-admin-role.js`) for existing installations
  - Frontend hook (`usePermission`) automatically grants super admins all permissions
  - Backend authentication automatically creates permission proxy for super admins
  - Updated TypeScript types to include `isSuperAdmin` flag
  - Comprehensive documentation in `SUPER_ADMIN.md`
  - Assign super admin via SQL: `UPDATE users SET role_id = 0 WHERE username = 'admin';`

## Fixed
- **User Management** - Fixed validation error when assigning super admin role (ID: 0) to users
  - Changed `role_id` validation from `!role_id` to `role_id === undefined || role_id === null`
  - Now correctly accepts `0` as a valid role ID
- **Sidebar Navigation** - Fixed super admin sidebar to show all menu items
  - Super admins now bypass permission checks in sidebar
  - All admin menus (Users, Settings, Tools, etc.) now visible to super admins
  - Custom post types and taxonomies also visible to super admins
  - Previously was incorrectly checking permissions even for super admins
- **User Management API** - Fixed super admin access to user creation, editing, and deletion
  - Added explicit super admin checks to all user API endpoints
  - Super admins can now create, edit, and delete users without permission errors
  - Endpoints now check `isSuperAdmin || hasPermission` instead of just permission
  - Fixed: `/api/users` (POST), `/api/users/[id]` (PUT, DELETE)
- **Multi-Site Settings Table** - Fixed "Table 'nextcms.settings' doesn't exist" error
  - Updated all API routes to use site-prefixed `settings` table (`site_1_settings`)
  - Fixed: `/api/users/route.ts`, `/api/users/[id]/route.ts` (password validation)
  - Fixed: `/api/settings/authentication/route.ts` (auth settings, password requirements)
  - Fixed: `/api/media/regenerate/route.ts` (image size settings)
  - Fixed: `/api/posts/[id]/revisions/[revisionId]/restore/route.ts` (revision settings)
  - All settings queries now respect current site context via `getSiteTable()` helper
- **Multi-Site Login** - Fixed default site assignment on login
  - Regular users now default to their first assigned site from `site_users` table
  - Super admins still default to site 1
  - Users will automatically land on the correct site after login
  - Previously all users defaulted to site 1 regardless of their assignments
- **Site Switcher UI** - Site switcher now always visible
  - Shows even if user has access to only one site
  - Provides visual confirmation of current site context
  - Makes site assignment clear at all times
- **Admin Layout** - Reorganized sidebar for better UX
  - Site switcher moved to sidebar (top, above Dashboard)
  - User info moved to sidebar (bottom, above Help)
  - Removed redundant header bar for cleaner interface
  - Dark theme styling for sidebar components
  - More compact and focused workspace
- **Media Manager** - Site-based folder structure
  - Media files now organized by site: `/uploads/site_1/YYYY/MM/`
  - Each site's media files are completely separated
  - Prevents file conflicts between sites
  - Easier to manage and backup per-site media
  - Existing file operations (delete, regenerate) work automatically
- **Post Meta API** - Fixed multi-site support for custom fields
  - Updated post meta route to use site-prefixed tables
  - Custom fields now save correctly for each site
  - Added super admin permission check
  - Fixed: `app/api/posts/[id]/meta/route.ts`
- **Multi-Site Routes Audit** - Completed full audit and update of all API routes
  - âœ… Updated 8 additional routes for multi-site support
  - âœ… Post types taxonomies, menu items, menu locations
  - âœ… Public menus (with site_id parameter), media usage, post terms
  - âœ… All routes now use `getSiteTable()` helper
  - âœ… All routes respect currentSiteId from session
  - âœ… Super admin checks added throughout
  - ~45 total routes verified for multi-site compatibility
- **Database Schema** - Documented multi-site default approach
  - New installations should use site-prefixed tables from start
  - Created migration guide for existing installations
  - Documented in `SCHEMA_UPDATE_NOTES.md`
  - Application code fully compatible with site-prefixed tables

